<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>KING GAME</title>
<style>
  :root{
    --neon:#00ff6a;
    --bg:#000;
    --card:#000;
    --input:#3a3a3a;
    --btn:#06c755;
  }
  *{box-sizing:border-box}
  body{
    margin:0;height:100vh;display:flex;align-items:center;justify-content:center;
    background: radial-gradient(ellipse at center, #020202 0%, #000 60%, #000 100%);
    font-family: Arial, Helvetica, sans-serif;
  }
  .card{
    position:relative;
    width:min(92vw,360px);
    background:var(--card);
    border-radius:20px;
    padding:26px 22px 18px;
    border:2px solid var(--neon);
    box-shadow:0 0 18px rgba(0,255,106,.55),
               0 0 44px rgba(0,255,106,.25);
  }
  .title{
    color:#fff;text-align:center;margin:0 0 16px;font-size:28px;font-weight:700;
  }
  .input{
    width:100%;height:48px;border:none;border-radius:14px;
    background:var(--input);color:#fff;font-size:16px;text-align:center;
    outline:none;margin-bottom:10px;
  }
  .error{
    display:none;color:#ff3b30;font-weight:700;text-align:center;margin:-2px 0 10px;
  }
  .btn{
    width:100%;height:52px;border:none;border-radius:14px;cursor:pointer;
    background:var(--btn);color:#fff;font-size:18px;font-weight:800;
    transition:transform .08s ease, box-shadow .2s;
    box-shadow:0 6px 18px rgba(6,199,85,.35);
  }
  .btn:active{ transform:scale(.98) }
  .btn:hover{ box-shadow:0 10px 26px rgba(6,199,85,.45) }
  .tools{
    display:flex;justify-content:center;align-items:center;gap:10px;margin-top:14px;
  }
  .cart{
    width:34px;height:34px;cursor:pointer;opacity:.95;transition:.2s;
  }
  .cart:hover{ transform:scale(1.1); }
  .hidden{display:none}
  #attempts{
    color:var(--neon);
    font-size:16px;
    font-weight:bold;
    margin-bottom:10px;
    text-align:center; /* المحاولات في النص */
  }
  #grid{
    text-align:center;  /* التوقعات في النص */
    font-size:20px;
    line-height:1.6;
  }
</style>
</head>
<body>

<!-- Login Card -->
<div id="loginBox" class="card">
  <h1 class="title">Log in</h1>
  <input id="userId" class="input" type="text" placeholder="ID" />
  <input id="code" class="input" type="text" placeholder="Code" autocomplete="one-time-code" />
  <div id="errorMsg" class="error">كود خطأ أو انتهى</div>
  <button class="btn" onclick="login()">Activate</button>

  <div class="tools">
    <span class="cart" title="تواصل على تيليجرام" onclick="openTelegram()">
      <svg xmlns="http://www.w3.org/2000/svg" 
           viewBox="0 0 24 24" fill="none" 
           stroke="white" stroke-width="2" 
           stroke-linecap="round" stroke-linejoin="round" 
           width="34" height="34">
        <circle cx="9" cy="21" r="2" fill="red"></circle>
        <circle cx="20" cy="21" r="2" fill="red"></circle>
        <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
      </svg>
    </span>
  </div>
</div>

<!-- Main/Game -->
<div id="mainBox" class="hidden">
  <div class="card" style="padding-top:18px">
    <h2 class="title" style="font-size:24px;margin-bottom:12px">الشبكة</h2>
    <div id="attempts">المحاولات: 0</div>
    <pre id="grid"></pre>
    <button class="btn" style="margin-top:8px" onclick="useAttempt()">توليد</button>
    <button class="btn" style="margin-top:8px;background:#333;color:#fff" onclick="copyGrid()">نسخ</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAF1K59iKFsVH-wyAKyGw2wsIMUIrT9WMg",
    authDomain: "admin-3fd30.firebaseapp.com",
    databaseURL: "https://admin-3fd30-default-rtdb.firebaseio.com",
    projectId: "admin-3fd30",
    storageBucket: "admin-3fd30.firebasestorage.app",
    messagingSenderId: "981773176798",
    appId: "1:981773176798:web:1ebc106e60af04ed8a174f",
    measurementId: "G-35L6036ED8"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const gem = "💎";
  const block = "🟦";
  let attempts = 0;
  let currentCode = "";

  window.openTelegram = () => {
    window.open("https://t.me/nbvvte", "_blank");
  };

  window.login = async () => {
    const userId = document.getElementById("userId").value.trim();
    const codeInput = document.getElementById("code").value.trim();
    const errorMsg = document.getElementById("errorMsg");

    if (!userId || !codeInput) {
      errorMsg.style.display = "block";
      errorMsg.textContent = " ID   ادخل الكود و";
      return;
    }

    try {
      const snap = await get(ref(db, "codes/" + codeInput));
      if (!snap.exists()) throw new Error("invalid");

      const data = snap.val();
      if ((data.remaining ?? 0) <= 0) throw new Error("exhausted");

      currentCode = codeInput;
      attempts = data.remaining;
      await update(ref(db, "codes/" + codeInput), { user: userId });

      errorMsg.style.display = "none";
      document.getElementById("loginBox").classList.add("hidden");
      document.getElementById("mainBox").classList.remove("hidden");
      updateAttemptsUI();
    } catch(e){
      errorMsg.style.display = "block";
      errorMsg.textContent = "كود خطأ أو انتهى";
    }
  };

  function updateAttemptsUI(){
    document.getElementById("attempts").textContent = "المحاولات: " + attempts;
  }

  window.useAttempt = async () => {
    if (attempts <= 0){
      logout();
      return;
    }
    attempts--;
    updateAttemptsUI();
    generateGrid();

    await update(ref(db, "codes/" + currentCode), { remaining: attempts });

    if (attempts <= 0){
      setTimeout(()=> logout(), 800);
    }
  };

  window.logout = () => {
    document.getElementById("mainBox").classList.add("hidden");
    document.getElementById("loginBox").classList.remove("hidden");
    document.getElementById("grid").textContent = "";
  };

  function generateGrid(){
    const total = 25;
    const gemCount = Math.floor(Math.random()*2)+4;
    const arr = Array(total).fill(block);
    let placed = 0;
    while(placed < gemCount){
      const i = Math.floor(Math.random()*total);
      if(arr[i] !== gem){ arr[i] = gem; placed++; }
    }
    let text = "";
    for(let r=0;r<5;r++){
      text += arr.slice(r*5,(r+1)*5).join(" ") + (r<4? "\n":"");
    }
    document.getElementById("grid").textContent = text;
  }

  window.copyGrid = () => {
    const t = document.getElementById("grid").textContent.trim();
    if(!t) return;
    navigator.clipboard.writeText(t).then(()=> alert("تم النسخ ✅"));
  };
</script>
</body>
</html>
