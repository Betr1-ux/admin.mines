<!DOCTYPE html>
<html lang="ar">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>KING GAME</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Cairo:wght@600;700&display=swap');

  :root{
    --neon:#00ffcc;
    --neon2:#00ff6a;
    --bg:#000;
    --card:#0d0d0d;
    --input:#1e1e1e;
    --btn:#06c755;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    height:100vh;
    display:flex;
    align-items:center;
    justify-content:center;
    background: radial-gradient(circle at top, #020202 0%, #000 100%);
    font-family: 'Cairo', sans-serif;
    color:#fff;
  }
  .card{
    position:relative;
    width:min(92vw,360px);
    background:var(--card);
    border-radius:20px;
    padding:28px 24px 20px;
    border:2px solid var(--neon2);
    box-shadow:0 0 22px rgba(0,255,170,.5),
               0 0 50px rgba(0,255,106,.25);
    animation: glow 2s infinite alternate;
  }
  @keyframes glow {
    from { box-shadow:0 0 20px rgba(0,255,204,.4); }
    to   { box-shadow:0 0 40px rgba(0,255,106,.6); }
  }
  .title{
    text-align:center;
    margin:0 0 18px;
    font-size:28px;
    font-weight:700;
    background:linear-gradient(90deg,var(--neon),var(--neon2));
    -webkit-background-clip:text;
    -webkit-text-fill-color:transparent;
  }
  .input{
    width:100%;height:50px;
    border:none;border-radius:14px;
    background:var(--input);
    color:#fff;font-size:16px;text-align:center;
    outline:none;margin-bottom:12px;
    transition:0.3s;
  }
  .input:focus{
    box-shadow:0 0 12px var(--neon2);
  }
  .error{
    display:none;
    color:#ff4c4c;
    font-weight:700;
    text-align:center;
    margin:6px 0 10px;
  }
  .btn{
    width:100%;
    height:52px;
    border:none;
    border-radius:14px;
    cursor:pointer;
    background:linear-gradient(135deg,var(--neon),var(--neon2));
    color:#000;
    font-size:18px;
    font-weight:800;
    transition:all .25s ease;
    box-shadow:0 6px 18px rgba(0,255,106,.35);
    margin-top:10px;
  }
  .btn:hover{
    transform:translateY(-2px);
    box-shadow:0 10px 26px rgba(0,255,106,.55);
  }
  .btn:active{ transform:scale(.97) }
  .tools{
    display:flex;
    justify-content:center;
    align-items:center;
    gap:12px;
    margin-top:14px;
  }
  .cart{
    width:38px;height:38px;
    cursor:pointer;
    opacity:.95;
    transition:.2s;
  }
  .cart:hover{ transform:scale(1.15); opacity:1 }
  .hidden{display:none}
  #attempts{
    color:var(--neon);
    font-size:16px;
    font-weight:bold;
    margin-bottom:10px;
    text-align:center;
  }
  #grid{
    text-align:center;
    font-size:20px;
    line-height:1.6;
    font-weight:600;
    letter-spacing:2px;
  }
  /* Ø§Ù„Ù„ÙˆØ¯Ø± */
  .loader {
    margin:15px auto;
    border:6px solid #222;
    border-top:6px solid var(--neon);
    border-radius:50%;
    width:60px;height:60px;
    animation: spin 1s linear infinite;
  }
  @keyframes spin {
    0% {transform:rotate(0deg)}
    100% {transform:rotate(360deg)}
  }
</style>
</head>
<body>

<!-- Login Card -->
<div id="loginBox" class="card">
  <h1 class="title">ğŸ”‘ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</h1>
  <input id="userId" class="input" type="text" placeholder="ID" />
  <input id="code" class="input" type="text" placeholder="Code" autocomplete="one-time-code" />
  <div id="errorMsg" class="error">âŒ ÙƒÙˆØ¯ Ø®Ø·Ø£ Ø£Ùˆ Ø§Ù†ØªÙ‡Ù‰</div>
  <button class="btn" onclick="login()">Activate</button>

  <div class="tools">
    <span class="cart" title="ØªÙˆØ§ØµÙ„ Ø¹Ù„Ù‰ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù…" onclick="openTelegram()">
      <img src="https://upload.wikimedia.org/wikipedia/commons/8/82/Telegram_logo.svg" width="34" height="34" />
    </span>
  </div>
</div>

<!-- Main/Game -->
<div id="mainBox" class="hidden">
  <div class="card" style="padding-top:18px">
    <h2 class="title" style="font-size:24px;margin-bottom:12px">ğŸ² Ø§Ù„Ø´Ø¨ÙƒØ©</h2>
    <div id="attempts">Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª: 0</div>

    <div id="loader" class="loader hidden"></div>
    <pre id="grid"></pre>

    <button class="btn" onclick="startGame()">â–¶ START</button>
    <button class="btn" style="background:#1c1c1c;color:#fff" onclick="resetGame()">ğŸ”„ RESET</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
  import { getDatabase, ref, get, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

  const firebaseConfig = {
    apiKey: "AIzaSyAF1K59iKFsVH-wyAKyGw2wsIMUIrT9WMg",
    authDomain: "admin-3fd30.firebaseapp.com",
    databaseURL: "https://admin-3fd30-default-rtdb.firebaseio.com",
    projectId: "admin-3fd30",
    storageBucket: "admin-3fd30.firebasestorage.app",
    messagingSenderId: "981773176798",
    appId: "1:981773176798:web:1ebc106e60af04ed8a174f",
    measurementId: "G-35L6036ED8"
  };

  const app = initializeApp(firebaseConfig);
  const db = getDatabase(app);

  const gem = "ğŸ’";
  const block = "ğŸŸ¦";
  let attempts = 0;
  let currentCode = "";

  window.openTelegram = () => {
    window.open("https://t.me/nbvvte", "_blank");
  };

  window.login = async () => {
    const userId = document.getElementById("userId").value.trim();
    const codeInput = document.getElementById("code").value.trim();
    const errorMsg = document.getElementById("errorMsg");

    if (!userId || !codeInput) {
      errorMsg.style.display = "block";
      errorMsg.textContent = "âš ï¸ ÙˆØ§Ù„ÙƒÙˆØ¯ ID Ø§Ø¯Ø®Ù„ Ø§Ù„Ù€";
      return;
    }

    try {
      const snap = await get(ref(db, "codes/" + codeInput));
      if (!snap.exists()) throw new Error("invalid");

      const data = snap.val();
      if ((data.remaining ?? 0) <= 0) throw new Error("exhausted");

      currentCode = codeInput;
      attempts = data.remaining;
      await update(ref(db, "codes/" + codeInput), { user: userId });

      errorMsg.style.display = "none";
      document.getElementById("loginBox").classList.add("hidden");
      document.getElementById("mainBox").classList.remove("hidden");
      updateAttemptsUI();
    } catch(e){
      errorMsg.style.display = "block";
      errorMsg.textContent = "âŒ ÙƒÙˆØ¯ Ø®Ø·Ø£ Ø£Ùˆ Ø§Ù†ØªÙ‡Ù‰";
    }
  };

  function updateAttemptsUI(){
    document.getElementById("attempts").textContent = "Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø§Øª: " + attempts;
  }

  window.startGame = async () => {
    if (attempts <= 0){
      logout();
      return;
    }
    attempts--;
    updateAttemptsUI();
    document.getElementById("grid").textContent = "";
    document.getElementById("loader").classList.remove("hidden");

    await update(ref(db, "codes/" + currentCode), { remaining: attempts });

    setTimeout(()=>{
      document.getElementById("loader").classList.add("hidden");
      generateGrid();
      if (attempts <= 0){
        setTimeout(()=> logout(), 1000);
      }
    },2000);
  };

  window.resetGame = () => {
    document.getElementById("grid").textContent = "";
    document.getElementById("loader").classList.add("hidden");
  };

  window.logout = () => {
    document.getElementById("mainBox").classList.add("hidden");
    document.getElementById("loginBox").classList.remove("hidden");
    document.getElementById("grid").textContent = "";
  };

  function generateGrid(){
    const total = 25;
    const gemCount = Math.floor(Math.random()*2)+4;
    const arr = Array(total).fill(block);
    let placed = 0;
    while(placed < gemCount){
      const i = Math.floor(Math.random()*total);
      if(arr[i] !== gem){ arr[i] = gem; placed++; }
    }
    let text = "";
    for(let r=0;r<5;r++){
      text += arr.slice(r*5,(r+1)*5).join(" ") + (r<4? "\n":"");
    }
    document.getElementById("grid").textContent = text;
  }
</script>
</body>
</html>
